# Secrets

## Create Secret
```
❯ kubectl create secret generic lab11 --from-literal=PASS=123456
secret/lab11 created
❯ kubectl get secret lab11
NAME    TYPE     DATA   AGE
lab11   Opaque   1      13s
❯ kubectl get secret lab11 -o jsonpath="{.data.PASS}" | base64 --decode
123456%
```

```
❯ gpg --list-keys
[keyboxd]
---------
pub   ed25519 2024-04-14 [SC] [expires: 2027-04-14]
      9391F50A08551029AAA391AEC68B6CBA56AB9B98
uid           [ultimate] yan <y.kozyrenko@innopolis.university>
sub   cv25519 2024-04-14 [E] [expires: 2027-04-14]

❯ sops -p 9391F50A08551029AAA391AEC68B6CBA56AB9B98 manual-flask/templates/secrets.yaml

❯ cat manual-flask/templates/secrets.yaml
password: ENC[AES256_GCM,data:tHu09AUMEF3ao3X4Lwc=,iv:kyR+twGM6IM6moyoNJOZ4DcQ2efmnpGa5HoNnaZoPSA=,tag:e4NUDO3QEFZsp8KaD8ClBw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-14T21:26:51Z"
    mac: ENC[AES256_GCM,data:hCnW9U/E6sQunqaV4FUu+IgKJnlT+DjlcXM1pGqnpbcXwIX7KMSDNvtg26RXKXW0RPj+qnVWdD/jpRCCZUIJRQ5o4FC76jHqJ8h5lc0htuNaevbxkQSr9A1+8kOGAdC9cFa9oSvx/Q3cPlfR14KQS2axxW3/MfZLCX1fe0IGvZQ=,iv:HAzNLgxavY7oDa/8zQ3KvimpG/X8o3s6zKMXaKu9+20=,tag:19RbppFa/0hfSdY4Qbcq6w==,type:str]
    pgp:
        - created_at: "2024-04-14T21:13:29Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hF4DSuZowMTy8koSAQdAq/1r6H2Vf2NGM9ggQNqhRKz3Pox+Mz7d2mmkehXVbwow
            sUTVVpBz2zXzRMJBoukKwdUPKenYFsU7D9A7CJ7FuOJgyBu7eo8YfG5VowaCVbjX
            1GYBCQIQ9MqaEmLqH6/IlL6aY6FiWTHYsYO5PfQV5kAcp/o+hj7API/BmbQnJ2ec
            zjCnrkHMSudRCVXcfJ5zhzcmczeI/aa6Xjxqf+5bKThgoGcMRvmoXk4xak4PC/VU
            MautpGA0PjA=
            =FjPi
            -----END PGP MESSAGE-----
          fp: 9391F50A08551029AAA391AEC68B6CBA56AB9B98
    unencrypted_suffix: _unencrypted
    version: 3.8.1

```

```
❯ helm secrets view manual-flask/templates/secrets.yaml
password: password123456
```

```
❯ kubectl get po
NAME                                       READY   STATUS    RESTARTS   AGE
manual-flask-1712682621-677c885b99-tmb5g   1/1     Running   0          8m5s

❯ kubectl exec manual-flask-1712682621-677c885b99-tmb5g -- printenv | grep MY_PASSWORD
MY_PASSWORD=password123456
```

## Installing secrets

```
❯ helm secrets install manual-flask ./manual-flask -n default -f ./manual-flask/secrets.yaml --replace
NAME: manual-flask
LAST DEPLOYED: Mon Apr 15 00:30:05 2024
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w manual-flask'
  export SERVICE_IP=$(kubectl get svc --namespace default manual-flask --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:5000
./manual-flask/secrets.yaml.dec
```

## Vault

```
❯ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
❯ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈
❯ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Mon Apr 15 00:38:47 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
❯ kubectl get pods
NAME                                       READY   STATUS              RESTARTS   AGE
manual-flask-1712682621-677c885b99-tmb5g   1/1     Running             0          10m
vault-0                                    0/1     ContainerCreating   0          5s
vault-agent-injector-dbfc5cd77-svn4m       0/1     ContainerCreating   0          5s
```

```
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

/ $ vault kv put internal/database/config username="user" password="password123456"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-14T21:42:44.289384625Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-14T21:42:44.289384625Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    password123456
username    user
/ $ exit
```